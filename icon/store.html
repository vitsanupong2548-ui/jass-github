<!DOCTYPE html>
<html lang="th">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin - Store & Merch</title>
    <!-- นำเข้า Tailwind CSS ผ่าน CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        brandPink: '#ff7eb3', // สีชมพูตามแบบ
                        brandGrayLight: '#d1d5db',
                        brandGrayDark: '#a3a3a3'
                    },
                    fontFamily: {
                        sans: ['Segoe UI', 'Tahoma', 'Geneva', 'Verdana', 'sans-serif'],
                    }
                }
            }
        }
    </script>
    <style>
        /* ซ่อน scrollbar สำหรับ sidebar แต่ยังเลื่อนได้ */
        
        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }
        
        .no-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
        /* Custom Checkbox */
        
        .custom-checkbox {
            appearance: none;
            width: 1.25rem;
            height: 1.25rem;
            border: 1px solid #000;
            display: inline-block;
            vertical-align: middle;
            position: relative;
            cursor: pointer;
        }
        
        .custom-checkbox:checked::after {
            content: '✓';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 0.875rem;
            color: black;
        }
    </style>
</head>

<body class="bg-white text-black h-screen flex overflow-hidden">

    <!-- Sidebar -->
    <aside class="w-[250px] border-r border-black flex flex-col flex-shrink-0 h-full overflow-y-auto no-scrollbar pb-10">
        <h2 class="text-2xl font-bold px-6 py-8">Admin</h2>

        <nav class="flex flex-col w-full text-lg">
            <div class="px-6 py-2 font-bold cursor-pointer hover:bg-gray-100">Festival & Event</div>

            <div class="flex flex-col">
                <div class="px-6 py-2 font-bold cursor-pointer hover:bg-gray-100">Musician Network</div>
                <ul class="pl-12 pr-6 text-base space-y-1">
                    <li class="cursor-pointer hover:text-brandPink">Artist Library</li>
                    <li class="cursor-pointer hover:text-brandPink">Jazz Network</li>
                </ul>
            </div>

            <div class="px-6 py-2 font-bold cursor-pointer hover:bg-gray-100 mt-2">Courses Library</div>
            <div class="px-6 py-2 font-bold cursor-pointer hover:bg-gray-100">CMBigband</div>
            <div class="px-6 py-2 font-bold cursor-pointer hover:bg-gray-100">Forum Q&A</div>

            <!-- Active Menu -->
            <div class="bg-brandPink text-white mt-2">
                <div class="px-6 py-2 font-bold">Store & Merch</div>
                <ul class="bg-white text-black pl-12 pr-6 py-2 text-base space-y-1">
                    <li class="cursor-pointer hover:text-brandPink font-medium tab-menu" onclick="switchTab('product')">Add Product</li>
                    <li class="cursor-pointer hover:text-brandPink tab-menu" onclick="switchTab('stock')">Stock</li>
                    <li class="cursor-pointer hover:text-brandPink tab-menu" onclick="switchTab('order')">Order</li>
                </ul>
            </div>
        </nav>
    </aside>

    <!-- Main Content -->
    <main class="flex-1 flex flex-col h-full overflow-y-auto items-center p-8">

        <div class="w-full max-w-5xl">
            <!-- Page Title -->
            <h1 id="page-title" class="text-4xl font-bold text-center mb-6">ช่องเพิ่มสินค้า</h1>

            <!-- Pink Banner -->
            <div class="bg-brandPink text-white text-3xl font-bold p-8 rounded-lg mb-6 shadow-sm">
                Store & Merch
            </div>

            <!-- Tab Buttons -->
            <div class="flex w-full rounded-lg overflow-hidden border border-black mb-8 h-12">
                <button id="btn-product" onclick="switchTab('product')" class="flex-1 tab-btn bg-brandPink text-white font-bold border-r border-black transition-colors">Product</button>
                <button id="btn-stock" onclick="switchTab('stock')" class="flex-1 tab-btn bg-[#d1d5db] text-gray-500 font-medium border-r border-black transition-colors hover:bg-gray-300">Stock</button>
                <button id="btn-order" onclick="switchTab('order')" class="flex-1 tab-btn bg-[#e5e7eb] text-gray-500 font-medium transition-colors hover:bg-gray-300">Order</button>
            </div>

            <!-- TAB CONTENT 1: Product -->
            <div id="tab-product" class="tab-content block">
                <!-- Hidden File Inputs -->
                <input type="file" id="upload-banner" accept="image/*" class="hidden" onchange="previewBanner(this)">
                <input type="file" id="upload-images" accept="image/*" multiple class="hidden" onchange="handleProductImages(this)">

                <!-- Banner Image Upload -->
                <div id="banner-container" class="w-full h-40 bg-[#a3a3a3] flex items-center justify-center font-bold text-black text-lg mb-6 cursor-pointer hover:bg-gray-400 transition relative overflow-hidden" onclick="document.getElementById('upload-banner').click()">
                    <span id="banner-text">+ Add Banner Image</span>
                    <img id="banner-preview" src="" class="absolute inset-0 w-full h-full object-cover hidden">
                </div>

                <!-- Product Images Upload -->
                <div class="flex flex-wrap gap-4 mb-6" id="product-images-container">
                    <div class="w-32 h-32 border-2 border-black flex items-center justify-center text-center text-sm font-bold cursor-pointer hover:bg-gray-50 transition p-2 bg-white flex-shrink-0" onclick="document.getElementById('upload-images').click()">
                        + Add<br>Product<br>Image<br>(Max. 5)
                    </div>
                    <!-- รูปภาพที่เลือกจะถูกสร้างขึ้นมาแสดงตรงนี้ด้วย Javascript -->
                </div>

                <!-- Form Inputs -->
                <div class="flex flex-col gap-4 mb-6">
                    <input type="text" id="p_name" placeholder="Product Name" class="w-full border border-black rounded-full px-5 py-2.5 outline-none focus:ring-2 focus:ring-brandPink">

                    <div class="flex gap-4">
                        <input type="number" id="p_price" placeholder="product Price" class="flex-1 border border-black rounded-full px-5 py-2.5 outline-none focus:ring-2 focus:ring-brandPink">
                        <input type="number" id="p_stock" placeholder="stock" class="w-1/3 border border-black rounded-full px-5 py-2.5 outline-none focus:ring-2 focus:ring-brandPink">
                    </div>

                    <textarea id="p_details" placeholder="Details ...." rows="4" class="w-full border border-black rounded-3xl px-5 py-4 outline-none focus:ring-2 focus:ring-brandPink resize-none"></textarea>
                </div>

                <!-- Checkboxes & Submit -->
                <div class="flex justify-between items-center">
                    <div class="flex gap-6">
                        <!-- เปลี่ยนเป็น Radio เพื่อให้เลือกได้แค่อย่างใดอย่างหนึ่ง -->
                        <label class="flex items-center gap-2 cursor-pointer">
                            <input type="radio" name="sale_status" value="open" class="custom-checkbox" checked>
                            <span class="text-sm font-medium">Sale Open</span>
                        </label>
                        <label class="flex items-center gap-2 cursor-pointer">
                            <input type="radio" name="sale_status" value="close" class="custom-checkbox">
                            <span class="text-sm font-medium">Sale Close</span>
                        </label>
                    </div>

                    <button onclick="submitProductForm()" class="bg-brandPink hover:bg-pink-500 text-white font-bold py-2.5 px-8 rounded-full shadow-md transition-colors">
                        + Add Product
                    </button>
                </div>
            </div>

            <!-- TAB CONTENT 2: Stock -->
            <div id="tab-stock" class="tab-content hidden w-full overflow-x-auto">
                <table class="w-full border-collapse border border-black text-center">
                    <thead>
                        <tr class="bg-white">
                            <th class="border border-black px-4 py-4 font-normal">ลำดับ (No.)</th>
                            <th class="border border-black px-4 py-4 font-normal">สินค้า (Product)</th>
                            <th class="border border-black px-4 py-4 font-normal">จำนวนคงเหลือ ( Balance)</th>
                            <th class="border border-black px-4 py-4 font-normal w-48">จัดการ (Action)</th>
                        </tr>
                    </thead>
                    <tbody id="stock-table-body">
                        <!-- ข้อมูลจะถูกโหลดมาแสดงที่นี่ผ่าน JavaScript -->
                        <tr class="h-10">
                            <td colspan="4" class="border border-black text-gray-500">คลิกที่แท็บนี้เพื่อโหลดข้อมูล...</td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <!-- TAB CONTENT 3: Order -->
            <div id="tab-order" class="tab-content hidden w-full overflow-x-auto">
                <table class="w-full text-center text-[10px] md:text-xs">
                    <thead>
                        <tr class="font-bold">
                            <th class="px-2 py-3">Time</th>
                            <th class="px-2 py-3">Order Code</th>
                            <th class="px-2 py-3">Product Code</th>
                            <th class="px-2 py-3">Customer Name</th>
                            <th class="px-2 py-3">Address</th>
                            <th class="px-2 py-3">Phone</th>
                            <th class="px-2 py-3">Email</th>
                            <th class="px-2 py-3">Amount</th>
                            <th class="px-2 py-3">Payment</th>
                            <th class="px-2 py-3">Status</th>
                        </tr>
                    </thead>
                    <tbody id="order-table-body">
                        <!-- ข้อมูลจะถูกโหลดมาแสดงที่นี่ผ่าน JavaScript -->
                        <tr>
                            <td colspan="10" class="px-2 py-8 text-center text-gray-500">คลิกที่แท็บนี้เพื่อโหลดข้อมูลคำสั่งซื้อ...</td>
                        </tr>
                    </tbody>
                </table>
            </div>

        </div>
    </main>

    <!-- Edit Product Modal -->
    <div id="edit-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex justify-center items-center py-4">
        <div class="bg-white p-6 md:p-8 rounded-2xl w-full max-w-lg shadow-xl max-h-[95vh] overflow-y-auto no-scrollbar">
            <h2 class="text-2xl font-bold mb-4 text-center">แก้ไขข้อมูลสินค้า</h2>
            <input type="hidden" id="edit_p_id">

            <!-- ส่วนแก้ไขรูปภาพ -->
            <div class="mb-6 border-b pb-6">
                <p class="text-sm text-gray-500 mb-2 font-medium">รูปภาพ (อัปโหลดใหม่เพื่อแทนที่รูปเดิม)</p>

                <!-- Hidden File Inputs สำหรับหน้า Edit -->
                <input type="file" id="edit-upload-banner" accept="image/*" class="hidden" onchange="previewEditBanner(this)">
                <input type="file" id="edit-upload-images" accept="image/*" multiple class="hidden" onchange="handleEditProductImages(this)">

                <!-- Edit Banner Image -->
                <div id="edit-banner-container" class="w-full h-24 bg-[#e5e7eb] border border-dashed border-gray-400 flex items-center justify-center font-bold text-gray-500 text-sm mb-4 cursor-pointer hover:bg-gray-200 transition relative overflow-hidden rounded" onclick="document.getElementById('edit-upload-banner').click()">
                    <span id="edit-banner-text">+ Change Banner Image</span>
                    <img id="edit-banner-preview" src="" class="absolute inset-0 w-full h-full object-cover hidden">
                </div>

                <!-- Edit Product Images -->
                <div class="flex flex-wrap gap-2" id="edit-product-images-container">
                    <div class="w-20 h-20 border border-dashed border-gray-400 flex items-center justify-center text-center text-xs font-bold text-gray-500 cursor-pointer hover:bg-gray-100 transition p-1 bg-white flex-shrink-0" onclick="document.getElementById('edit-upload-images').click()">
                        + Change<br>Images<br>(Max 5)
                    </div>
                    <!-- รูปภาพที่เลือกแก้ไขจะถูกแสดงตรงนี้ -->
                </div>
            </div>

            <!-- ส่วนแก้ไขข้อมูล Text -->
            <div class="flex flex-col gap-4 mb-6">
                <div>
                    <label class="block text-sm font-bold mb-1">ชื่อสินค้า</label>
                    <input type="text" id="edit_p_name" class="w-full border border-black rounded-full px-4 py-2 outline-none focus:ring-2 focus:ring-brandPink">
                </div>

                <div class="flex gap-4">
                    <div class="flex-1">
                        <label class="block text-sm font-bold mb-1">ราคา</label>
                        <input type="number" id="edit_p_price" class="w-full border border-black rounded-full px-4 py-2 outline-none focus:ring-2 focus:ring-brandPink">
                    </div>
                    <div class="w-1/3">
                        <label class="block text-sm font-bold mb-1">สต๊อก</label>
                        <input type="number" id="edit_p_stock" class="w-full border border-black rounded-full px-4 py-2 outline-none focus:ring-2 focus:ring-brandPink">
                    </div>
                </div>

                <div>
                    <label class="block text-sm font-bold mb-1">รายละเอียด</label>
                    <textarea id="edit_p_details" rows="3" class="w-full border border-black rounded-2xl px-4 py-2 outline-none focus:ring-2 focus:ring-brandPink resize-none"></textarea>
                </div>

                <div class="flex gap-6 mt-2">
                    <label class="flex items-center gap-2 cursor-pointer">
                        <input type="radio" name="edit_sale_status" value="open" class="custom-checkbox">
                        <span class="text-sm font-medium">Sale Open</span>
                    </label>
                    <label class="flex items-center gap-2 cursor-pointer">
                        <input type="radio" name="edit_sale_status" value="close" class="custom-checkbox">
                        <span class="text-sm font-medium">Sale Close</span>
                    </label>
                </div>
            </div>

            <div class="flex justify-end gap-4 mt-6">
                <button onclick="closeEditModal()" class="bg-gray-300 text-black px-6 py-2 rounded-full hover:bg-gray-400 transition-colors font-bold">ยกเลิก</button>
                <button onclick="saveEditedProduct()" class="bg-brandPink text-white px-6 py-2 rounded-full hover:bg-pink-600 transition-colors font-bold">บันทึก</button>
            </div>
        </div>
    </div>

    <!-- JavaScript สำหรับควบคุมการทำงานของ Tab -->
    <script>
        // Global variables สำหรับเก็บข้อมูลสินค้า
        let currentStockData = [];

        // ==========================================
        // ส่วนจัดการรูปภาพสินค้า (หน้า Add Product)
        // ==========================================
        let selectedBanner = null;
        let selectedProductImages = [];

        function previewBanner(input) {
            if (input.files && input.files[0]) {
                selectedBanner = input.files[0];
                const reader = new FileReader();
                reader.onload = function(e) {
                    const img = document.getElementById('banner-preview');
                    img.src = e.target.result;
                    img.classList.remove('hidden');
                    document.getElementById('banner-text').classList.add('hidden');
                }
                reader.readAsDataURL(input.files[0]);
            }
        }

        function handleProductImages(input) {
            const files = Array.from(input.files);
            const remainingSlots = 5 - selectedProductImages.length;

            if (files.length > remainingSlots) {
                alert(`คุณสามารถเพิ่มรูปภาพได้อีกแค่ ${remainingSlots} รูป (สูงสุด 5 รูป)`);
            }

            const filesToAdd = files.slice(0, remainingSlots);
            filesToAdd.forEach(file => selectedProductImages.push(file));

            renderProductImagePreviews();
            input.value = '';
        }

        function renderProductImagePreviews() {
            const container = document.getElementById('product-images-container');
            const addButton = container.firstElementChild;

            container.innerHTML = '';
            container.appendChild(addButton);

            selectedProductImages.forEach((file, index) => {
                const imgDiv = document.createElement('div');
                imgDiv.className = 'relative w-32 h-32 flex-shrink-0 border border-gray-300 group';
                imgDiv.innerHTML = `
                    <img class="w-full h-full object-cover">
                    <button type="button" onclick="removeProductImage(${index}, event)" class="absolute top-1 right-1 bg-red-500 text-white rounded-full w-6 h-6 flex items-center justify-center text-xs opacity-0 group-hover:opacity-100 transition-opacity">X</button>
                `;
                container.appendChild(imgDiv);

                const reader = new FileReader();
                reader.onload = function(e) {
                    imgDiv.querySelector('img').src = e.target.result;
                }
                reader.readAsDataURL(file);
            });
        }

        function removeProductImage(index, event) {
            event.stopPropagation();
            selectedProductImages.splice(index, 1);
            renderProductImagePreviews();
        }

        // ==========================================
        // ส่วนจัดการรูปภาพสินค้า (หน้า Edit Product Modal)
        // ==========================================
        let editSelectedBanner = null;
        let editExistingProductImages = []; // เก็บพาร์ทรูปเดิมที่มีอยู่แล้วบนเซิร์ฟเวอร์
        let editSelectedProductImages = []; // เก็บไฟล์รูปใหม่ที่จะอัปโหลดไปเพิ่ม

        function previewEditBanner(input) {
            if (input.files && input.files[0]) {
                editSelectedBanner = input.files[0];
                const reader = new FileReader();
                reader.onload = function(e) {
                    const img = document.getElementById('edit-banner-preview');
                    img.src = e.target.result;
                    img.classList.remove('hidden');
                    document.getElementById('edit-banner-text').classList.add('hidden');
                }
                reader.readAsDataURL(input.files[0]);
            }
        }

        function handleEditProductImages(input) {
            const files = Array.from(input.files);
            const totalCurrentImages = editExistingProductImages.length + editSelectedProductImages.length;
            const remainingSlots = 5 - totalCurrentImages;

            if (files.length > remainingSlots) {
                alert(`คุณสามารถเลือกรูปภาพใหม่ได้อีกแค่ ${remainingSlots} รูป (สูงสุดรวมกัน 5 รูป)`);
            }

            const filesToAdd = files.slice(0, remainingSlots);
            filesToAdd.forEach(file => editSelectedProductImages.push(file));

            renderEditProductImagePreviews();
            input.value = '';
        }

        function renderEditProductImagePreviews() {
            const container = document.getElementById('edit-product-images-container');
            const addButton = container.firstElementChild;

            container.innerHTML = '';
            container.appendChild(addButton);

            // 1. นำรูปที่มีอยู่แล้ว (จาก Database) มาแสดง
            editExistingProductImages.forEach((imageUrl, index) => {
                const imgDiv = document.createElement('div');
                imgDiv.className = 'relative w-20 h-20 flex-shrink-0 border border-gray-300 group';
                imgDiv.innerHTML = `
                    <img src="${imageUrl}" class="w-full h-full object-cover">
                    <button type="button" onclick="removeExistingEditProductImage(${index}, event)" class="absolute top-1 right-1 bg-red-500 text-white rounded-full w-5 h-5 flex items-center justify-center text-[10px] opacity-0 group-hover:opacity-100 transition-opacity">X</button>
                `;
                container.appendChild(imgDiv);
            });

            // 2. นำรูปที่ผู้ใช้อัปโหลดมาใหม่ (ยังไม่ถูกบันทึก) มาแสดงต่อท้าย
            editSelectedProductImages.forEach((file, index) => {
                const imgDiv = document.createElement('div');
                imgDiv.className = 'relative w-20 h-20 flex-shrink-0 border border-gray-300 group';
                imgDiv.innerHTML = `
                    <img class="w-full h-full object-cover">
                    <button type="button" onclick="removeEditProductImage(${index}, event)" class="absolute top-1 right-1 bg-red-500 text-white rounded-full w-5 h-5 flex items-center justify-center text-[10px] opacity-0 group-hover:opacity-100 transition-opacity">X</button>
                `;
                container.appendChild(imgDiv);

                const reader = new FileReader();
                reader.onload = function(e) {
                    imgDiv.querySelector('img').src = e.target.result;
                }
                reader.readAsDataURL(file);
            });
        }

        function removeExistingEditProductImage(index, event) {
            event.stopPropagation();
            editExistingProductImages.splice(index, 1);
            renderEditProductImagePreviews();
        }

        function removeEditProductImage(index, event) {
            event.stopPropagation();
            editSelectedProductImages.splice(index, 1);
            renderEditProductImagePreviews();
        }

        // ==========================================
        // ส่วนบันทึกข้อมูลหน้า Add (Submit to PHP Backend)
        // ==========================================
        async function submitProductForm() {
            const name = document.getElementById('p_name').value;
            const price = document.getElementById('p_price').value;
            const stock = document.getElementById('p_stock').value;
            const details = document.getElementById('p_details').value;
            const saleStatus = document.querySelector('input[name="sale_status"]:checked').value;

            // ตรวจสอบค่าว่าง
            if (!name || !price || !stock) {
                alert('กรุณากรอก ชื่อสินค้า, ราคา และ จำนวนสต๊อก ให้ครบถ้วน');
                return;
            }

            const formData = new FormData();
            formData.append('action', 'add_product');
            formData.append('product_name', name);
            formData.append('product_price', price);
            formData.append('product_stock', stock);
            formData.append('product_details', details);
            formData.append('sale_status', saleStatus);

            if (selectedBanner) {
                formData.append('image_banner', selectedBanner);
            }

            selectedProductImages.forEach((file) => {
                formData.append('product_images[]', file);
            });

            try {
                const response = await fetch('storebackend.php', {
                    method: 'POST',
                    body: formData
                });

                const result = await response.json();

                if (result.status === 'success') {
                    alert('เพิ่มสินค้าเรียบร้อยแล้ว!');
                    document.getElementById('p_name').value = '';
                    document.getElementById('p_price').value = '';
                    document.getElementById('p_stock').value = '';
                    document.getElementById('p_details').value = '';

                    selectedBanner = null;
                    document.getElementById('banner-preview').classList.add('hidden');
                    document.getElementById('banner-text').classList.remove('hidden');

                    selectedProductImages = [];
                    renderProductImagePreviews();
                } else {
                    alert('เกิดข้อผิดพลาด: ' + result.message);
                }
            } catch (error) {
                console.error('Error:', error);
                alert('ไม่สามารถเชื่อมต่อกับฐานข้อมูลได้ (โปรดตรวจสอบว่าเปิดใช้งาน storebackend.php แล้ว)');
            }
        }

        // ==========================================
        // ส่วนควบคุมการเปลี่ยนแท็บ
        // ==========================================
        function switchTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(el => {
                el.classList.add('hidden');
                el.classList.remove('block');
            });

            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('bg-brandPink', 'text-white', 'font-bold');
                btn.classList.add('text-gray-500', 'font-medium');
                if (btn.id === 'btn-product') btn.classList.add('bg-[#d1d5db]');
                if (btn.id === 'btn-stock') btn.classList.add('bg-[#d1d5db]');
                if (btn.id === 'btn-order') btn.classList.add('bg-[#e5e7eb]');
            });

            document.querySelectorAll('.tab-menu').forEach(menu => {
                menu.classList.remove('font-bold');
                menu.classList.add('font-medium');
            });

            const activeTab = document.getElementById('tab-' + tabName);
            const activeBtn = document.getElementById('btn-' + tabName);

            activeTab.classList.remove('hidden');
            activeTab.classList.add('block');

            activeBtn.classList.remove('bg-[#d1d5db]', 'bg-[#e5e7eb]', 'text-gray-500', 'font-medium');
            activeBtn.classList.add('bg-brandPink', 'text-white', 'font-bold');

            const titleElement = document.getElementById('page-title');
            if (tabName === 'product') {
                titleElement.innerText = 'ช่องเพิ่มสินค้า';
            } else if (tabName === 'stock') {
                titleElement.innerText = 'จัดการสต๊อก (Stock)';
                loadStockData();
            } else if (tabName === 'order') {
                titleElement.innerText = 'รายการสั่งซื้อ (Order)';
                loadOrderData(); // เรียกใช้ฟังก์ชันโหลดออเดอร์
            }
        }

        // ==========================================
        // ส่วนโหลดข้อมูลออเดอร์ (Load Order Data)
        // ==========================================
        async function loadOrderData() {
            const tbody = document.getElementById('order-table-body');
            tbody.innerHTML = '<tr><td colspan="10" class="px-2 py-8 text-center text-gray-500">กำลังโหลดข้อมูล...</td></tr>';

            try {
                const response = await fetch('storebackend.php?action=get_orders');
                const result = await response.json();

                if (result.status === 'success') {
                    tbody.innerHTML = '';

                    if (result.data.length === 0) {
                        tbody.innerHTML = '<tr><td colspan="10" class="px-2 py-8 text-center text-gray-500">ไม่มีข้อมูลคำสั่งซื้อในระบบ</td></tr>';
                        return;
                    }

                    result.data.forEach((item) => {
                        const tr = document.createElement('tr');
                        tr.className = 'border-b border-gray-100 hover:bg-gray-50';

                        // ฟอร์แมตวันที่ให้สวยขึ้น (ตัวเลือกเพิ่มเติม)
                        const dateObj = new Date(item.created_at);
                        const formattedDate = dateObj.toLocaleDateString('th-TH') + ' : ' +
                            dateObj.getHours().toString().padStart(2, '0') + '.' +
                            dateObj.getMinutes().toString().padStart(2, '0');

                        // กำหนดสีของป้ายสถานะ (Badge)
                        let paymentBadge = '';
                        if (item.payment_status === 'pending') paymentBadge = '<span class="bg-[#ffc107] text-black px-3 py-1 rounded-full font-bold">Pending</span>';
                        else if (item.payment_status === 'success') paymentBadge = '<span class="bg-[#28a745] text-white px-3 py-1 rounded-full font-bold">Success</span>';
                        else paymentBadge = '<span class="bg-[#dc3545] text-white px-3 py-1 rounded-full font-bold">Failed</span>';

                        let orderBadge = '';
                        if (item.order_status === 'pending') orderBadge = '<span class="bg-[#ffc107] text-black px-3 py-1 rounded-full font-bold">Pending</span>';
                        else if (item.order_status === 'success') orderBadge = '<span class="bg-[#28a745] text-white px-3 py-1 rounded-full font-bold">Success</span>';
                        else orderBadge = '<span class="bg-[#dc3545] text-white px-3 py-1 rounded-full font-bold">Canceled</span>';

                        tr.innerHTML = `
                            <td class="px-2 py-3">${formattedDate}</td>
                            <td class="px-2 py-3">${item.order_code}</td>
                            <td class="px-2 py-3">${item.product_code}</td>
                            <td class="px-2 py-3">${item.customer_name}</td>
                            <td class="px-2 py-3">${item.address}</td>
                            <td class="px-2 py-3">${item.phone}</td>
                            <td class="px-2 py-3">${item.email || '-'}</td>
                            <td class="px-2 py-3">${item.amount}</td>
                            <td class="px-2 py-3">${paymentBadge}</td>
                            <td class="px-2 py-3">${orderBadge}</td>
                        `;
                        tbody.appendChild(tr);
                    });
                } else {
                    tbody.innerHTML = `<tr><td colspan="10" class="px-2 py-8 text-center text-red-500">เกิดข้อผิดพลาด: ${result.message}</td></tr>`;
                }
            } catch (error) {
                console.error('Error fetching orders:', error);
                tbody.innerHTML = '<tr><td colspan="10" class="px-2 py-8 text-center text-red-500">ไม่สามารถเชื่อมต่อฐานข้อมูลได้</td></tr>';
            }
        }

        // ==========================================
        // ส่วนโหลดข้อมูลสต๊อก (Load Stock Data)
        // ==========================================
        async function loadStockData() {
            const tbody = document.getElementById('stock-table-body');
            tbody.innerHTML = '<tr><td colspan="4" class="border border-black h-10 text-gray-500">กำลังโหลดข้อมูล...</td></tr>';

            try {
                const response = await fetch('storebackend.php?action=get_stock');
                const result = await response.json();

                if (result.status === 'success') {
                    tbody.innerHTML = '';
                    currentStockData = result.data;

                    if (result.data.length === 0) {
                        tbody.innerHTML = '<tr><td colspan="4" class="border border-black h-10 text-gray-500">ไม่มีข้อมูลสินค้าในระบบ</td></tr>';
                        return;
                    }

                    result.data.forEach((item, index) => {
                        const tr = document.createElement('tr');
                        tr.className = 'h-10 hover:bg-gray-50 transition-colors';

                        const stockClass = item.stock_balance <= 5 ? 'text-red-500 font-bold' : '';

                        tr.innerHTML = `
                            <td class="border border-black px-4 py-2">${index + 1}</td>
                            <td class="border border-black px-4 py-2 text-left">${item.name} <span class="text-xs text-gray-500 ml-2">(${item.product_code})</span></td>
                            <td class="border border-black px-4 py-2 ${stockClass}">${item.stock_balance}</td>
                            <td class="border border-black px-4 py-2">
                                <div class="flex gap-2 justify-center">
                                    <button onclick="openEditModal(${item.product_id})" class="bg-[#d1d5db] text-black hover:bg-brandPink hover:text-white px-4 py-1 rounded-full text-sm font-bold transition-colors">แก้ไข</button>
                                    <button onclick="deleteProduct(${item.product_id})" class="bg-red-500 text-white hover:bg-red-600 px-4 py-1 rounded-full text-sm font-bold transition-colors">ลบ</button>
                                </div>
                            </td>
                        `;
                        tbody.appendChild(tr);
                    });
                } else {
                    tbody.innerHTML = `<tr><td colspan="4" class="border border-black h-10 text-red-500">เกิดข้อผิดพลาด: ${result.message}</td></tr>`;
                }
            } catch (error) {
                console.error('Error fetching stock:', error);
                tbody.innerHTML = '<tr><td colspan="4" class="border border-black h-10 text-red-500">ไม่สามารถเชื่อมต่อฐานข้อมูลได้</td></tr>';
            }
        }

        // ==========================================
        // ส่วนจัดการการแก้ไขสินค้า (Edit Product)
        // ==========================================
        function openEditModal(productId) {
            const product = currentStockData.find(p => p.product_id == productId);
            if (!product) return;

            // นำข้อมูล Text ไปใส่ใน Modal
            document.getElementById('edit_p_id').value = product.product_id;
            document.getElementById('edit_p_name').value = product.name;
            document.getElementById('edit_p_price').value = product.price || 0;
            document.getElementById('edit_p_stock').value = product.stock_balance;
            document.getElementById('edit_p_details').value = product.description || '';

            if (product.sale_status === 'close') {
                document.querySelector('input[name="edit_sale_status"][value="close"]').checked = true;
            } else {
                document.querySelector('input[name="edit_sale_status"][value="open"]').checked = true;
            }

            // เตรียมดึงข้อมูลรูปภาพเก่า (จาก JSON string ใน DB)
            editExistingProductImages = [];
            if (product.image_products) {
                try {
                    // แปลง JSON String ที่ได้จาก Database กลับมาเป็น Array ของ URL
                    const parsedImages = typeof product.image_products === 'string' ?
                        JSON.parse(product.image_products) :
                        product.image_products;

                    if (Array.isArray(parsedImages)) {
                        editExistingProductImages = parsedImages;
                    }
                } catch (e) {
                    console.error("Error parsing image_products", e);
                }
            }

            // จัดการแสดงผล Banner เดิม (ถ้ามีใน Database)
            editSelectedBanner = null;
            const bannerPreview = document.getElementById('edit-banner-preview');
            const bannerText = document.getElementById('edit-banner-text');

            if (product.image_banner && product.image_banner.trim() !== '') {
                bannerPreview.src = product.image_banner;
                bannerPreview.classList.remove('hidden');
                bannerText.classList.add('hidden');
            } else {
                bannerPreview.src = '';
                bannerPreview.classList.add('hidden');
                bannerText.classList.remove('hidden');
            }

            // รีเซ็ตไฟล์ใหม่ที่จะอัปโหลด
            editSelectedProductImages = [];

            // สั่งประมวลผลวาดรูป
            renderEditProductImagePreviews();

            // แสดง Modal
            document.getElementById('edit-modal').classList.remove('hidden');
        }

        function closeEditModal() {
            document.getElementById('edit-modal').classList.add('hidden');
        }

        // ==========================================
        // ส่วนจัดการลบสินค้า (Delete Product)
        // ==========================================
        async function deleteProduct(productId) {
            if (confirm('คุณแน่ใจหรือไม่ที่จะลบสินค้านี้? ข้อมูลและรูปภาพจะถูกลบอย่างถาวร')) {
                const formData = new FormData();
                formData.append('action', 'delete_product');
                formData.append('product_id', productId);

                try {
                    const response = await fetch('storebackend.php', {
                        method: 'POST',
                        body: formData
                    });

                    const result = await response.json();

                    if (result.status === 'success') {
                        alert('ลบสินค้าเรียบร้อยแล้ว');
                        loadStockData(); // โหลดข้อมูลสต๊อกใหม่ทันทีหลังจากลบ
                    } else {
                        alert('เกิดข้อผิดพลาด: ' + result.message);
                    }
                } catch (error) {
                    console.error('Error deleting product:', error);
                    alert('ไม่สามารถเชื่อมต่อกับฐานข้อมูลได้');
                }
            }
        }

        async function saveEditedProduct() {
            const id = document.getElementById('edit_p_id').value;
            const name = document.getElementById('edit_p_name').value;
            const price = document.getElementById('edit_p_price').value;
            const stock = document.getElementById('edit_p_stock').value;
            const details = document.getElementById('edit_p_details').value;
            const saleStatus = document.querySelector('input[name="edit_sale_status"]:checked').value;

            if (!name || !price || !stock) {
                alert('กรุณากรอก ชื่อสินค้า, ราคา และ จำนวนสต๊อก ให้ครบถ้วน');
                return;
            }

            const formData = new FormData();
            formData.append('action', 'update_product');
            formData.append('product_id', id);
            formData.append('product_name', name);
            formData.append('product_price', price);
            formData.append('product_stock', stock);
            formData.append('product_details', details);
            formData.append('sale_status', saleStatus);

            // แนบพาธของ "รูปเก่าที่ยังไม่โดนกดลบ" กลับไปให้ Backend ด้วย (เพื่อไม่ให้สูญหาย)
            editExistingProductImages.forEach((url) => {
                formData.append('existing_images[]', url);
            });

            // แนบไฟล์รูปภาพหากมีการอัปโหลดใหม่เข้ามาในหน้าแก้ไข
            if (editSelectedBanner) {
                formData.append('image_banner', editSelectedBanner);
            }

            editSelectedProductImages.forEach((file) => {
                formData.append('product_images[]', file);
            });

            try {
                const response = await fetch('storebackend.php', {
                    method: 'POST',
                    body: formData
                });

                const result = await response.json();

                if (result.status === 'success') {
                    alert('อัปเดตข้อมูลสินค้าเรียบร้อยแล้ว!');
                    closeEditModal();
                    loadStockData(); // โหลดตารางใหม่เพื่อให้แสดงจำนวนสต๊อกล่าสุด
                } else {
                    alert('เกิดข้อผิดพลาด: ' + result.message);
                }
            } catch (error) {
                console.error('Error updating product:', error);
                alert('ไม่สามารถเชื่อมต่อกับฐานข้อมูลได้');
            }
        }
    </script>
</body>

</html>